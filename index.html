<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Suivi des Dossiers Clients - Pelichet</title>
  <link href="https://fonts.googleapis.com/css2?family=Trebuchet+MS&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" rel="stylesheet">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#d95c14">
  <link rel="apple-touch-icon" href="logo-192.png">
  <style>
    body { font-family: 'Trebuchet MS', sans-serif; padding: 20px; background: #f9f9f9; }
    #loginBox, #mainApp { max-width: 800px; margin: auto; }
    form, #loginBox { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
    input, select, textarea { width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; }
    button { background: #d95c14; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
    #userDisplay { font-weight: bold; margin-bottom: 20px; }
    #calendar { background: white; padding: 20px; border-radius: 10px; margin-top: 20px; }
    table.dataTable { width: 100% !important; background: white; margin-top: 20px; }
    nav { margin-bottom: 20px; text-align: center; }
    nav button { margin-right: 10px; }
    section { display: none; }
    section.active { display: block; }
  </style>
</head>
<body>

<div id="loginBox">
  <h3>Connexion</h3>
  <label>Email :</label>
  <input type="email" id="loginEmail" required>
  <label>Mot de passe :</label>
  <input type="password" id="loginPassword" required>
  <button onclick="login()">Se connecter</button>
  <p id="loginError" style="color: red;"></p>
</div>

<div id="mainApp" style="display: none;">
  <header>
    <img src="LOGO-PELICHET.jpg" alt="Logo Pelichet" style="height: 60px;">
    <h1>Suivi des Dossiers Clients</h1>
  </header>

  <p id="userDisplay"></p>

  <nav>
    <button onclick="showSection('formulaire')">Formulaire</button>
    <button onclick="showSection('tableau')">Tableau</button>
    <button onclick="showSection('calendrier')">Calendrier</button>
  </nav>

  <section id="formulaire" class="active">
    <form id="intervention-form">
      <input type="hidden" id="utilisateur" name="utilisateur">
      <label>Client :</label><input type="text" id="client" name="client" required>
      <label>Dossier :</label><input type="text" id="dossier" name="dossier" required>
      <label>Moyens :</label><input type="text" id="moyens" name="moyens">
      <label>Date :</label><input type="date" id="date" name="date" required>
      <label>Montant :</label><input type="number" id="montant" name="montant" step="0.01">
      <label>Couleur :</label><input type="color" id="couleur" name="couleur" value="#d95c14">
      <label>Commentaires :</label><textarea id="commentaires" name="commentaires"></textarea>
      <button type="button" onclick="submitForm()">Enregistrer</button>
      <div id="confirmation"></div>
    </form>
  </section>

  <section id="tableau">
    <table id="dataTable" class="display">
      <thead>
        <tr><th>Client</th><th>Dossier</th><th>Moyens</th><th>Date</th><th>Montant</th><th>Commentaires</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="calendrier">
    <div id="calendar"></div>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

<script>
  const users = {
    "arnaud.guedou@pelichet.ch": { password: "arnaud2024", nom: "Arnaud" },
    "nicolas.corazzol@pelichet.ch": { password: "nicolas2024", nom: "Nicolas" }
  };
  let userEmail = "";

  function login() {
    const email = document.getElementById("loginEmail").value.trim();
    const password = document.getElementById("loginPassword").value;
    if (users[email] && users[email].password === password) {
      userEmail = email;
      document.getElementById("loginBox").style.display = "none";
      document.getElementById("mainApp").style.display = "block";
      document.getElementById("utilisateur").value = email;
      document.getElementById("userDisplay").textContent = "Connect√© : " + users[email].nom;
      showSection('formulaire');
      loadData();
    } else {
      document.getElementById("loginError").textContent = "Email ou mot de passe incorrect.";
    }
  }

  function showSection(id) {
    document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if (id === 'calendrier' && calendar) calendar.render();
  }

  let calendar;

  function submitForm() {
    const data = new FormData(document.getElementById("intervention-form"));
    const params = new URLSearchParams();
    for (const [key, value] of data.entries()) {
      params.append(key, value);
    }
    params.append("utilisateur", userEmail);

    fetch("TON_SCRIPT_URL", { method: "POST", body: params })
      .then(res => res.text())
      .then(() => {
        document.getElementById("confirmation").textContent = "Donn√©e enregistr√©e.";
        document.getElementById("intervention-form").reset();
        loadData();
      });
  }

  function loadData() {
    if (!userEmail) return;
    document.getElementById("userDisplay").textContent = "Dossiers pour : " + userEmail;
    fetch("TON_SCRIPT_URL?utilisateur=" + encodeURIComponent(userEmail))
      .then(res => res.json())
      .then(data => {
        const table = $('#dataTable').DataTable();
        table.clear();
        data.forEach(row => {
          table.row.add([
            row.client,
            row.dossier,
            row.moyens,
            formatDate(row.date),
            row.montant,
            row.commentaires,
            `<button onclick='deleteEntry("${row.horodatage}")'>üóëÔ∏è</button>`
          ]);
        });
        table.draw();
        calendar.removeAllEvents();
        data.forEach(row => {
          if (row.date) {
            calendar.addEvent({
              title: row.client + " (" + row.dossier + ")",
              start: row.date,
              color: row.couleur || '#d95c14'
            });
          }
        });
      });
  }

  function deleteEntry(horodatage) {
    if (!confirm("Supprimer ?")) return;
    const params = new URLSearchParams();
    params.append("delete", "1");
    params.append("horodatage", horodatage);
    params.append("utilisateur", userEmail);

    fetch("TON_SCRIPT_URL", { method: "POST", body: params })
      .then(res => res.text())
      .then(() => loadData());
  }

  function formatDate(dateStr) {
    const date = new Date(dateStr);
    return isNaN(date) ? dateStr : date.toLocaleDateString("fr-FR");
  }

  document.addEventListener('DOMContentLoaded', function () {
    calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
      initialView: 'dayGridMonth',
      locale: 'fr',
      events: []
    });
    calendar.render();
    $('#dataTable').DataTable();
  });
</script>
</body>
</html>
